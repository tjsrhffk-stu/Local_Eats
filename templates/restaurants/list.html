{% extends 'base.html' %}
{% block title %}ìŒì‹ì  ëª©ë¡ â€” LocalEats{% endblock %}

{% block extra_css %}
<style>
  .page-header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 40px 24px 32px;
  }
  .page-header-inner { max-width: 1200px; margin: 0 auto; }
  .page-title {
    font-family: 'Playfair Display', serif;
    font-size: 36px; font-weight: 700; margin-bottom: 24px;
  }

  /* SEARCH BAR */
  .search-bar {
    display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
    margin-bottom: 20px;
  }
  .search-wrap {
    position: relative; flex: 1; min-width: 240px;
  }
  .search-wrap input {
    width: 100%; padding: 12px 16px 12px 44px;
    background: var(--bg); border: 1.5px solid var(--border);
    border-radius: 12px; font-size: 15px; color: var(--text);
    font-family: 'DM Sans', sans-serif; outline: none; transition: all 0.2s;
  }
  .search-wrap input:focus { border-color: var(--accent); background: var(--surface); }
  .search-wrap .icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 18px; }
  .search-bar select {
    padding: 12px 16px; background: var(--bg); border: 1.5px solid var(--border);
    border-radius: 12px; font-size: 14px; color: var(--text);
    font-family: 'DM Sans', sans-serif; outline: none; cursor: pointer;
    transition: all 0.2s;
  }
  .search-bar select:focus { border-color: var(--accent); }
  .search-bar button {
    padding: 12px 24px; background: var(--accent); color: #fff;
    border: none; border-radius: 12px; font-size: 14px; font-weight: 600;
    font-family: 'DM Sans', sans-serif; cursor: pointer; transition: all 0.2s;
    white-space: nowrap;
  }
  .search-bar button:hover { background: var(--accent-hover); }

  /* FILTER CHIPS */
  .filter-row { display: flex; gap: 8px; flex-wrap: wrap; }
  .chip {
    padding: 7px 16px; border-radius: 100px; font-size: 13px; font-weight: 500;
    background: var(--bg); border: 1.5px solid var(--border); color: var(--text2);
    text-decoration: none; transition: all 0.2s; cursor: pointer;
  }
  .chip:hover { border-color: var(--accent); color: var(--accent); }
  .chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }

  /* RESULTS INFO */
  .results-info {
    display: flex; justify-content: space-between; align-items: center;
    padding: 24px 0 20px; flex-wrap: wrap; gap: 12px;
  }
  .results-count { font-size: 14px; color: var(--text2); }
  .results-count strong { color: var(--text); }
  .sort-select {
    padding: 8px 14px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; font-size: 13px; color: var(--text);
    font-family: 'DM Sans', sans-serif; outline: none; cursor: pointer;
  }

  /* GRID */
  .restaurants-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
  .restaurant-card {
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: var(--radius); overflow: hidden;
    box-shadow: var(--shadow); transition: all var(--transition);
    text-decoration: none; color: inherit; display: block;
    animation: fadeUp 0.4s ease both;
  }
  .restaurant-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); border-color: var(--accent); }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

  .card-img {
    height: 190px; background: var(--bg2); position: relative;
    display: flex; align-items: center; justify-content: center; font-size: 60px;
    overflow: hidden;
  }
  .card-img img { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; }
  .card-img-overlay {
    position: absolute; inset: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.25) 0%, transparent 50%);
  }
  .card-category-tag {
    position: absolute; bottom: 12px; left: 12px;
    background: rgba(0,0,0,0.55); backdrop-filter: blur(4px);
    color: #fff; font-size: 12px; font-weight: 600;
    padding: 4px 10px; border-radius: 100px;
  }
  .fav-btn {
    position: absolute; top: 12px; right: 12px;
    width: 34px; height: 34px; border-radius: 50%;
    background: rgba(255,255,255,0.9); border: none; cursor: pointer;
    font-size: 16px; display: flex; align-items: center; justify-content: center;
    transition: transform 0.2s; backdrop-filter: blur(4px);
  }
  .fav-btn:hover { transform: scale(1.15); }

  .card-body { padding: 20px; }
  .card-name { font-size: 18px; font-weight: 600; margin-bottom: 6px; }
  .card-address { font-size: 13px; color: var(--text2); margin-bottom: 14px; display: flex; align-items: center; gap: 4px; }
  .card-stars { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; }
  .stars { display: flex; gap: 2px; }
  .stars .on { color: #F59E0B; font-size: 16px; }
  .stars .off { color: var(--star-off); font-size: 16px; }
  .rating-num { font-weight: 700; font-size: 15px; color: var(--text); }
  .review-count { font-size: 13px; color: var(--text2); }
  .card-footer {
    border-top: 1px solid var(--border); padding-top: 14px;
    display: flex; justify-content: space-between; align-items: center;
  }
  .card-phone { font-size: 13px; color: var(--text2); }
  .card-link-btn {
    font-size: 13px; font-weight: 600; color: var(--accent);
    display: flex; align-items: center; gap: 4px;
  }

  /* EMPTY STATE */
  .empty-state {
    grid-column: 1 / -1; text-align: center; padding: 80px 24px;
  }
  .empty-icon { font-size: 64px; margin-bottom: 20px; }
  .empty-title { font-size: 22px; font-weight: 600; margin-bottom: 10px; }
  .empty-desc { color: var(--text2); font-size: 15px; }

  /* PAGINATION */
  .pagination { display: flex; justify-content: center; align-items: center; gap: 6px; margin-top: 48px; }
  .page-btn {
    min-width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
    border-radius: 10px; font-size: 14px; font-weight: 500;
    border: 1.5px solid var(--border); background: var(--surface); color: var(--text);
    text-decoration: none; transition: all 0.2s;
  }
  .page-btn:hover { border-color: var(--accent); color: var(--accent); }
  .page-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; font-weight: 700; }
  .page-btn.disabled { opacity: 0.3; pointer-events: none; }
</style>
{% endblock %}

{% block content %}
<div style="margin: -40px -24px 0; padding: 40px 24px 32px; background: var(--surface); border-bottom: 1px solid var(--border);">
  <div style="max-width: 1200px; margin: 0 auto;">
    <h1 style="font-family:'Playfair Display',serif; font-size:36px; font-weight:700; margin-bottom:24px;">ìŒì‹ì  ì°¾ê¸°</h1>
    <form method="GET" id="searchForm">
      <div class="search-bar">
        <div class="search-wrap">
          <span class="icon">ğŸ”</span>
          <input type="text" name="q" value="{{ request.GET.q }}" placeholder="ìŒì‹ì  ì´ë¦„ ê²€ìƒ‰...">
        </div>
        <select name="sort" onchange="this.form.submit()">
          <option value="" {% if not request.GET.sort %}selected{% endif %}>ì •ë ¬ ê¸°ì¤€</option>
          <option value="rating" {% if request.GET.sort == 'rating' %}selected{% endif %}>ë³„ì  ë†’ì€ ìˆœ</option>
          <option value="reviews" {% if request.GET.sort == 'reviews' %}selected{% endif %}>ë¦¬ë·° ë§ì€ ìˆœ</option>
          <option value="newest" {% if request.GET.sort == 'newest' %}selected{% endif %}>ìµœì‹  ë“±ë¡ ìˆœ</option>
        </select>
        <button type="submit">ê²€ìƒ‰</button>
      </div>
      <div class="filter-row">
        <a href="/restaurants/" class="chip {% if not request.GET.category %}active{% endif %}">ğŸ½ï¸ ì „ì²´</a>
        <a href="?category=í•œì‹{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="chip {% if request.GET.category == 'í•œì‹' %}active{% endif %}">ğŸš í•œì‹</a>
        <a href="?category=ì¼ì‹{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="chip {% if request.GET.category == 'ì¼ì‹' %}active{% endif %}">ğŸ£ ì¼ì‹</a>
        <a href="?category=ì–‘ì‹{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="chip {% if request.GET.category == 'ì–‘ì‹' %}active{% endif %}">ğŸ ì–‘ì‹</a>
        <a href="?category=ì¤‘ì‹{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="chip {% if request.GET.category == 'ì¤‘ì‹' %}active{% endif %}">ğŸ¥Ÿ ì¤‘ì‹</a>
        <a href="?category=ì¹´í˜{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="chip {% if request.GET.category == 'ì¹´í˜' %}active{% endif %}">â˜• ì¹´í˜</a>
        <a href="?category=ë¶„ì‹{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="chip {% if request.GET.category == 'ë¶„ì‹' %}active{% endif %}">ğŸ¥š ë¶„ì‹</a>
        <a href="?category=ë””ì €íŠ¸{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="chip {% if request.GET.category == 'ë””ì €íŠ¸' %}active{% endif %}">ğŸ° ë””ì €íŠ¸</a>
      </div>
    </form>
  </div>
</div>

<div style="max-width:1200px;margin:0 auto;padding:0 24px;">
  <div class="results-info">
    <span class="results-count">
      <strong>{{ restaurants|length }}</strong>ê°œì˜ ìŒì‹ì 
      {% if request.GET.q %} â€” "<strong>{{ request.GET.q }}</strong>" ê²€ìƒ‰ ê²°ê³¼{% endif %}
    </span>
  </div>

  <div class="restaurants-grid">
    {% for restaurant in restaurants %}
    <a href="/restaurants/{{ restaurant.pk }}/" class="restaurant-card" style="animation-delay: {{ forloop.counter0 }}0ms">
      <div class="card-img">
        {% if restaurant.image %}
          <img src="{{ restaurant.image.url }}" alt="{{ restaurant.name }}">
        {% else %}
          ğŸ½ï¸
        {% endif %}
        <div class="card-img-overlay"></div>
        <span class="card-category-tag">{{ restaurant.category|default:"ê¸°íƒ€" }}</span>
        {% if user.is_authenticated %}
        <button class="fav-btn" onclick="event.preventDefault(); toggleFav({{ restaurant.pk }}, this)" title="ì¦ê²¨ì°¾ê¸°">
          {% if restaurant.pk in user_favorites %}â¤ï¸{% else %}ğŸ¤{% endif %}
        </button>
        {% endif %}
      </div>
      <div class="card-body">
        <div class="card-name">{{ restaurant.name }}</div>
        <div class="card-address">ğŸ“ {{ restaurant.address|truncatechars:30 }}</div>
        <div class="card-stars">
          <div class="stars">
            {% with avg=restaurant.avg_rating|default:0 %}
            {% for i in "12345" %}
              {% if forloop.counter <= avg %}
                <span class="on">â˜…</span>
              {% else %}
                <span class="off">â˜…</span>
              {% endif %}
            {% endfor %}
            {% endwith %}
          </div>
          <span class="rating-num">{{ restaurant.avg_rating|default:"â€”" }}</span>
          <span class="review-count">({{ restaurant.review_count|default:0 }}ê°œ ë¦¬ë·°)</span>
        </div>
        <div class="card-footer">
          <span class="card-phone">{{ restaurant.phone|default:"ì „í™”ë²ˆí˜¸ ì—†ìŒ" }}</span>
          <span class="card-link-btn">ìƒì„¸ë³´ê¸° â†’</span>
        </div>
      </div>
    </a>
    {% empty %}
    <div class="empty-state">
      <div class="empty-icon">ğŸ½ï¸</div>
      <div class="empty-title">ìŒì‹ì ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”</div>
      <div class="empty-desc">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ ì¹´í…Œê³ ë¦¬ë¡œ ì‹œë„í•´ë³´ì„¸ìš”</div>
    </div>
    {% endfor %}
  </div>

  <!-- PAGINATION -->
  {% if restaurants.has_other_pages %}
  <div class="pagination">
    {% if restaurants.has_previous %}
      <a href="?page={{ restaurants.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="page-btn">â†</a>
    {% else %}
      <span class="page-btn disabled">â†</span>
    {% endif %}
    {% for num in restaurants.paginator.page_range %}
      {% if num == restaurants.number %}
        <span class="page-btn active">{{ num }}</span>
      {% elif num|add:"-2" <= restaurants.number and num|add:"2" >= restaurants.number %}
        <a href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="page-btn">{{ num }}</a>
      {% endif %}
    {% endfor %}
    {% if restaurants.has_next %}
      <a href="?page={{ restaurants.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="page-btn">â†’</a>
    {% else %}
      <span class="page-btn disabled">â†’</span>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleFav(restaurantId, btn) {
  fetch(`/favorites/toggle/${restaurantId}/`, {
    method: 'POST',
    headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' }
  }).then(r => r.json()).then(data => {
    btn.textContent = data.is_favorite ? 'â¤ï¸' : 'ğŸ¤';
  }).catch(() => {});
}
function getCookie(name) {
  return document.cookie.split(';').map(c => c.trim()).find(c => c.startsWith(name + '='))?.split('=')[1] || '';
}
</script>
{% endblock %}